<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="npoint-url" content="https://api.npoint.io/ca2dd7866fc47d012b78">
  <title>Essen des Tages</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    #container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007BFF;
    }
    h2 {
      margin-top: 0;
      color: #0056b3;
    }
    ul {
      list-style: disc;
      margin-left: 20px;
      padding-left: 20px;
    }
    #randomMealButton {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #randomMealButton:hover {
      background-color: #0056b3;
    }
    form label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    form textarea {
      min-height: 100px;
      resize: vertical;
    }
    form button[type="submit"] {
      margin-top: 20px;
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    form button[type="submit"]:hover {
      background-color: #1e7e34;
    }
    .status-message {
      margin-top: 15px;
      min-height: 1.2em;
    }
    #allMeals {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .meal-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      background: #fafafa;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .meal-card h3 {
      margin: 0;
      color: #007BFF;
    }
    .meal-day-tag {
      display: inline-block;
      align-self: flex-start;
      padding: 4px 8px;
      border-radius: 12px;
      background: #e8f1ff;
      color: #0056b3;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .instructions {
      white-space: pre-wrap;
    }
    summary {
      font-size: 20px;
      font-weight: 600;
      color: #0056b3;
      cursor: pointer;
      margin-top: 30px;
    }
    details[open] summary {
      color: #007BFF;
    }
  </style>
</head>

<body>
  <div id="container">
    <h1 id="currentDay">Heutiger Tag:</h1>

    <div id="mealDisplay">
      <h2 id="mealName"></h2>
      <h3>Zutaten:</h3>
      <ul id="ingredients"></ul>
      <h3>Zubereitung:</h3>
      <p id="instructions" class="instructions"></p>
    </div>

    <button id="randomMealButton">Neues Essen anzeigen</button>

    <details id="addMeal">
      <summary>Neues Gericht hinzufügen</summary>
      <form id="mealForm" novalidate>
        <label for="day">Wochentag</label>
        <select id="day" name="day" required>
          <option value="Montag">Montag</option>
          <option value="Dienstag">Dienstag</option>
          <option value="Mittwoch">Mittwoch</option>
          <option value="Donnerstag">Donnerstag</option>
          <option value="Freitag">Freitag</option>
          <option value="Samstag">Samstag</option>
          <option value="Sonntag">Sonntag</option>
          <option value="any">Beliebig (jeder Tag)</option>
        </select>

        <label for="name">Gerichtsname</label>
        <input id="name" name="name" type="text" placeholder="z. B. Spaghetti Bolognese" required>

        <label for="ingredientsInput">Zutaten (eine pro Zeile oder Komma-getrennt)</label>
        <textarea id="ingredientsInput" name="ingredients" placeholder="z. B. Spaghetti, Tomatensoße, Parmesan" required></textarea>

        <label for="instructionsInput">Zubereitung</label>
        <textarea id="instructionsInput" name="instructions" placeholder="Beschreibe hier die Zubereitung." required></textarea>

        <button type="submit">Gericht speichern</button>
      </form>
      <p id="formStatus" class="status-message" role="status" aria-live="polite"></p>
    </details>

    <details id="allMealsSection">
      <summary>Alle gespeicherten Gerichte</summary>
      <div id="allMeals"></div>
    </details>
  </div>

  <script>
    const meta = document.querySelector('meta[name="npoint-url"]');
    const NPOINT_URL = meta?.content?.replace(/\/$/, '') || 'https://api.npoint.io/DEINE_ID';
    const mealNameEl = document.getElementById('mealName');
    const ingredientsEl = document.getElementById('ingredients');
    const instructionsEl = document.getElementById('instructions');
    const randomBtn = document.getElementById('randomMealButton');
    const form = document.getElementById('mealForm');
    const dayInput = document.getElementById('day');
    const nameInput = document.getElementById('name');
    const ingredientsInput = document.getElementById('ingredientsInput');
    const instructionsInput = document.getElementById('instructionsInput');
    const formStatus = document.getElementById('formStatus');
    const allMealsContainer = document.getElementById('allMeals');

    const days = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
    const todayString = days[new Date().getDay()];
    document.getElementById('currentDay').textContent = "Heutiger Tag: " + todayString;

    let meals = [];
    let todaysMeals = [];

    function normalizeIngredients(text) {
      return [...new Set(text.split(/[\n,]/).map(s => s.trim()).filter(Boolean))];
    }

    function displayMeal(meal) {
      mealNameEl.textContent = meal ? meal.name : '';
      ingredientsEl.innerHTML = '';
      instructionsEl.textContent = meal ? meal.instructions : '';
      if (meal) {
        meal.ingredients.forEach(i => {
          const li = document.createElement('li');
          li.textContent = i;
          ingredientsEl.appendChild(li);
        });
      }
    }

    function updateTodayMeals() {
      todaysMeals = meals.filter(m => m.day?.toLowerCase() === 'any' || m.day === todayString);
      if (todaysMeals.length === 0) {
        displayMeal(null);
        mealNameEl.textContent = 'Kein passendes Gericht gefunden für ' + todayString;
        randomBtn.disabled = true;
      } else {
        displayMeal(todaysMeals[0]);
        randomBtn.disabled = false;
      }
    }

    function randomMeal() {
      if (!todaysMeals.length) return;
      const idx = Math.floor(Math.random() * todaysMeals.length);
      displayMeal(todaysMeals[idx]);
    }
    randomBtn.addEventListener('click', randomMeal);

    function renderAllMeals() {
      allMealsContainer.innerHTML = '';
      if (!meals.length) {
        allMealsContainer.textContent = 'Noch keine Gerichte vorhanden.';
        return;
      }
      const frag = document.createDocumentFragment();
      meals
        .slice()
        .sort((a,b) => (a.day||'').localeCompare(b.day||'') || a.name.localeCompare(b.name))
        .forEach(m => {
          const card = document.createElement('article');
          card.className = 'meal-card';
          card.innerHTML = `
            <span class="meal-day-tag">${(m.day?.toLowerCase()==='any'?'Beliebig':(m.day||''))}</span>
            <h3>${m.name}</h3>
            <h4>Zutaten</h4>
            <ul>${(m.ingredients||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
            <h4>Zubereitung</h4>
            <p class="instructions">${m.instructions||''}</p>
          `;
          frag.appendChild(card);
        });
      allMealsContainer.appendChild(frag);
    }

    async function loadMeals() {
      const res = await fetch(NPOINT_URL, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
      if (!res.ok) throw new Error('Laden fehlgeschlagen: ' + res.status);
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }

    async function saveMeals(nextMeals) {
      // ✅ Schema-konformes JSON ohne Zusatzfelder
      const validated = nextMeals.map(m => ({
        day: String(m.day || '').trim(),
        name: String(m.name || '').trim(),
        ingredients: Array.isArray(m.ingredients)
          ? [...new Set(m.ingredients.map(String))]
          : [],
        instructions: String(m.instructions || '').trim()
      }));

      const res = await fetch(NPOINT_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(validated)
      });

      if (!res.ok) throw new Error('Speichern fehlgeschlagen: ' + res.status);
      return res.json();
    }

    (async () => {
      try {
        meals = await loadMeals();
        renderAllMeals();
        updateTodayMeals();
      } catch (e) {
        console.error(e);
        mealNameEl.textContent = 'Fehler beim Laden der Gerichte.';
        randomBtn.disabled = true;
      }
    })();

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      formStatus.textContent = 'Gericht wird gespeichert…';

      const newMeal = {
        day: dayInput.value.trim(),
        name: nameInput.value.trim(),
        ingredients: normalizeIngredients(ingredientsInput.value),
        instructions: instructionsInput.value.trim()
      };

      if (!newMeal.day || !newMeal.name || !newMeal.instructions || !newMeal.ingredients.length) {
        formStatus.textContent = 'Bitte alle Felder ausfüllen (mindestens eine Zutat).';
        return;
      }

      try {
        const current = await loadMeals();
        const exists = current.some(m => m.name.toLowerCase() === newMeal.name.toLowerCase() && m.day === newMeal.day);
        if (exists) {
          formStatus.textContent = 'Dieses Gericht existiert für diesen Tag bereits.';
          return;
        }

        const next = current.concat(newMeal);
        await saveMeals(next);

        meals = next;
        renderAllMeals();
        updateTodayMeals();
        form.reset();
        formStatus.textContent = 'Gericht gespeichert!';
      } catch (err) {
        console.error(err);
        formStatus.textContent = 'Speichern fehlgeschlagen. Bitte später erneut versuchen.';
      }
    });
  </script>
</body>
</html>
